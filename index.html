<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORACLE: Campaign Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .metric-card {
            background-color: #1F2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            height: 100%;
        }
        .metric-title {
            color: #9CA3AF; /* gray-400 */
            font-size: 0.875rem;
            font-weight: 500;
        }
        .prediction-value {
             color: #D1D5DB; /* gray-300 */
             font-size: 1.25rem;
             font-weight: 600;
        }
        .input-label {
            color: #9CA3AF; /* gray-400 */
        }
        .input-field {
            background-color: #374151; /* gray-700 */
            border: 1px solid #4B5563; /* gray-600 */
            color: #F9FAFB; /* gray-50 */
            border-radius: 0.5rem;
        }
        .funnel-stage-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #fff;
            border-bottom: 2px solid #4f46e5; /* indigo-600 */
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .action-button, .modal-button {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .action-button:hover, .modal-button:hover {
            background-color: #4338ca; /* indigo-700 */
            transform: scale(1.05);
        }
        .modal-button {
             padding: 0.5rem 1rem; /* Smaller padding */
        }
        .highlight {
            color: #818cf8; /* indigo-300 */
            font-weight: 700;
            font-size: 1.5rem;
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-container {
            background-color: #1F2937;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-input {
            background-color: #374151;
            border: 1px solid #4B5563;
            color: #F9FAFB;
            border-radius: 0.375rem;
            padding: 0.5rem;
            width: 100%;
        }
        .calculated-percent {
            background-color: #111827;
            color: #6ee7b7;
            padding: 0.5rem;
            border-radius: 0.375rem;
            text-align: center;
            font-weight: bold;
        }
        /* Tooltip & Icon Styles */
        .icon-button, .info-icon {
            position: relative;
            display: inline-block;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .icon-button:hover, .info-icon:hover {
            transform: scale(1.15);
        }
        .tooltip {
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #374151;
            color: #fff;
            text-align: center;
            padding: 8px 12px;
            border-radius: 6px;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            font-weight: 400;
            width: 220px;
            white-space: normal;
        }
        .icon-button:hover .tooltip, .info-icon:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }
        .recommendation-card {
            background: linear-gradient(135deg, #1e3a8a, #4f46e5);
        }
        .recommendation-value {
            font-size: 1.875rem;
            font-weight: 700;
            color: #fff;
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 sm:p-6 md:p-8">

    <div class="max-w-5xl mx-auto">
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="text-center sm:text-left">
                    <h1 class="text-3xl sm:text-4xl font-bold text-white">ORACLE</h1>
                    <p class="text-lg text-gray-400 mt-2">Optimized Real-time Ads Conversion Level Estimator</p>
                </div>
                <button id="exportButton" class="action-button">
                    Export to Sheets (CSV)
                </button>
            </div>
        </header>
        
        <!-- Preset Selector -->
        <div class="mb-8 flex items-center gap-4">
            <label for="presetSelector" class="font-medium text-gray-300">Current Scenario:</label>
            <select id="presetSelector" class="input-field p-2 rounded-md"></select>
        </div>

        <!-- Input Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="metric-card">
                <label for="tofuSpend" class="block text-lg font-medium input-label mb-2">Enter TOFU Ad Spend ($)</label>
                <input type="number" id="tofuSpend" value="1000" class="w-full p-3 text-2xl font-bold input-field focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="metric-card">
                 <label for="frequencyGoal" class="block text-lg font-medium input-label mb-2">Target Frequency: <span id="frequencyValue" class="text-white font-bold">3</span></label>
                 <input id="frequencyGoal" type="range" min="1" max="10" value="3" step="0.5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>
        
        <!-- Budget Recommendation Section -->
        <div class="mb-8">
             <h2 class="text-2xl font-bold text-white mb-4 text-center">Budget Recommendations</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="metric-card recommendation-card">
                    <p class="metric-title flex items-center gap-1.5">Recommended MOFU Budget
                         <span class="info-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                            <span class="tooltip">A suggested budget to reach your MOFU audience with an effective ad frequency. Calculated as (Predicted Spend x Target Frequency).</span>
                        </span>
                    </p>
                    <p id="recommendedMofuBudget" class="recommendation-value">$0</p>
                </div>
                 <div class="metric-card recommendation-card">
                    <p class="metric-title flex items-center gap-1.5">Recommended BOFU Budget
                        <span class="info-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                            <span class="tooltip">A suggested budget to reach your BOFU audience with an effective ad frequency. Calculated as (Predicted Spend x Target Frequency).</span>
                        </span>
                    </p>
                    <p id="recommendedBofuBudget" class="recommendation-value">$0</p>
                </div>
             </div>
        </div>


        <!-- Main Grid for Predictions and Metrics -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Predictions Column -->
            <div class="lg:col-span-2 space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="metric-card">
                        <h2 class="funnel-stage-title">TOFU</h2>
                        <div class="space-y-4">
                            <div>
                                <p class="metric-title flex items-center gap-1.5">Accounts Reached 
                                    <span class="info-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                        <span class="tooltip">The estimated number of unique people who will see your ads at this stage.</span>
                                    </span>
                                </p><p id="tofu-reach" class="highlight">0</p>
                            </div>
                            <div>
                                <p class="metric-title flex items-center gap-1.5">Predicted Clicks
                                    <span class="info-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                        <span class="tooltip">The estimated number of clicks based on the reach and historical CTR.</span>
                                    </span>
                                </p><p id="tofu-clicks" class="prediction-value">0</p>
                            </div>
                            <div>
                                <p class="metric-title flex items-center gap-1.5">Predicted CTR
                                    <span class="info-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                        <span class="tooltip">Click-Through Rate. The percentage of people who see your ad and click it. Based on your historical KPIs.</span>
                                    </span>
                                </p><p id="tofu-ctr" class="prediction-value">0.00%</p>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h2 class="funnel-stage-title">MOFU</h2>
                        <div class="space-y-4">
                            <div>
                                <p class="metric-title flex items-center gap-1.5">Retargeting Pool
                                     <span class="info-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                        <span class="tooltip">The total audience available for this stage, based on the number of people reached in the previous stage.</span>
                                    </span>
                                </p><p id="mofu-pool" class="prediction-value">0</p>
                            </div>
                            <div>
                                <p class="metric-title flex items-center gap-1.5">Accounts Reached
                                     <span class="info-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                        <span class="tooltip">The estimated number of people reached from the retargeting pool, based on your historical retention rate.</span>
                                    </span>
                                </p><p id="mofu-reach" class="highlight">0</p>
                            </div>
                            <div>
                                <p class="metric-title flex items-center gap-1.5">Predicted Clicks
                                     <span class="info-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                        <span class="tooltip">The estimated number of clicks based on the reach and historical CTR for this stage.</span>
                                    </span>
                                </p><p id="mofu-clicks" class="prediction-value">0</p>
                            </div>
                            <div>
                                <p class="metric-title flex items-center gap-1.5">Predicted Spend (Baseline)
                                     <span class="info-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                        <span class="tooltip">This is a cost forecast, NOT a budget. It's the estimated cost to reach this audience at a low frequency (~1). Use the 'Recommended Budget' above for planning.</span>
                                    </span>
                                </p><p id="mofu-spend" class="prediction-value font-bold">$0</p>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h2 class="funnel-stage-title">BOFU</h2>
                        <div class="space-y-4">
                            <div>
                                <p class="metric-title flex items-center gap-1.5">Retargeting Pool
                                     <span class="info-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                        <span class="tooltip">The total audience available for this stage, based on the number of people reached in the previous stage.</span>
                                    </span>
                                </p><p id="bofu-pool" class="prediction-value">0</p>
                            </div>
                            <div>
                                <p class="metric-title flex items-center gap-1.5">Accounts Reached
                                     <span class="info-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                        <span class="tooltip">The estimated number of people reached from the retargeting pool, based on your historical retention rate.</span>
                                    </span>
                                </p><p id="bofu-reach" class="highlight">0</p>
                            </div>
                            <div>
                                <p class="metric-title flex items-center gap-1.5">Predicted Clicks
                                     <span class="info-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                        <span class="tooltip">The estimated number of clicks based on the reach and historical CTR for this stage.</span>
                                    </span>
                                </p><p id="bofu-clicks" class="prediction-value">0</p>
                            </div>
                            <div>
                                <p class="metric-title flex items-center gap-1.5">Predicted Spend (Baseline)
                                     <span class="info-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                        <span class="tooltip">This is a cost forecast, NOT a budget. It's the estimated cost to reach this audience at a low frequency (~1). Use the 'Recommended Budget' above for planning.</span>
                                    </span>
                                </p><p id="bofu-spend" class="prediction-value font-bold">$0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historical Metrics Column -->
            <div class="space-y-6">
                <div class="metric-card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-white">Historical KPIs</h3>
                        <button id="editKpisButton" class="icon-button" title="Edit KPIs">
                            <span class="tooltip">Edit the underlying metrics for the current scenario.</span>
                            <span class="text-2xl">🔮</span>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div><h4 class="font-bold text-indigo-400">TOFU</h4></div>
                        <div class="flex justify-between items-baseline"><span class="metric-title">Cost per 1k Reach</span><span class="font-semibold" id="tofu-cpm-metric">$0.00</span></div>
                        <div class="flex justify-between items-baseline"><span class="metric-title">Avg. CTR</span><span class="font-semibold" id="tofu-ctr-metric">0.00%</span></div>
                        <hr class="border-gray-700">
                        <div><h4 class="font-bold text-indigo-400">MOFU</h4></div>
                        <div class="flex justify-between items-baseline"><span class="metric-title">Avg. CTR</span><span class="font-semibold" id="mofu-ctr-metric">0.00%</span></div>
                        <div class="flex justify-between items-baseline"><span class="metric-title">Avg. CPC</span><span class="font-semibold" id="mofu-cpc-metric">$0.00</span></div>
                        <hr class="border-gray-700">
                        <div><h4 class="font-bold text-indigo-400">BOFU</h4></div>
                        <div class="flex justify-between items-baseline"><span class="metric-title">Avg. CTR</span><span class="font-semibold" id="bofu-ctr-metric">0.00%</span></div>
                        <div class="flex justify-between items-baseline"><span class="metric-title">Avg. CPC</span><span class="font-semibold" id="bofu-cpc-metric">$0.00</span></div>
                    </div>
                </div>
                 <div class="metric-card">
                    <h3 class="text-xl font-semibold text-white mb-4">Funnel Retention</h3>
                    <div class="space-y-4">
                         <div class="flex justify-between items-baseline"><span class="metric-title">TOFU → MOFU Reach</span><span class="font-semibold" id="mofu-retention-metric">0%</span></div>
                         <div class="flex justify-between items-baseline"><span class="metric-title">MOFU → BOFU Reach</span><span class="font-semibold" id="bofu-retention-metric">0%</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Editor Modal -->
    <div id="kpiModal" class="modal-overlay hidden">
        <div class="modal-container">
             <button id="closeModalButton" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6 text-white" id="modalTitle">Edit KPIs</h2>
            <div class="space-y-4">
                <!-- TOFU Inputs -->
                <div>
                    <h3 class="font-bold text-indigo-400 mb-2">TOFU</h3>
                    <label class="block text-sm font-medium text-gray-300">Cost per 1k Reach ($)</label>
                    <input type="number" step="0.01" id="modal_tofu_cpm" class="modal-input mt-1">
                    <label class="block text-sm font-medium text-gray-300 mt-2">Avg. CTR (%)</label>
                    <input type="number" step="0.01" id="modal_tofu_ctr" class="modal-input mt-1">
                </div>
                <hr class="border-gray-600">
                <!-- MOFU Inputs -->
                <div>
                    <h3 class="font-bold text-indigo-400 mb-2">MOFU</h3>
                    <label class="block text-sm font-medium text-gray-300">Avg. CTR (%)</label>
                    <input type="number" step="0.01" id="modal_mofu_ctr" class="modal-input mt-1">
                    <label class="block text-sm font-medium text-gray-300 mt-2">Avg. CPC ($)</label>
                    <input type="number" step="0.01" id="modal_mofu_cpc" class="modal-input mt-1">
                </div>
                <hr class="border-gray-600">
                <!-- BOFU Inputs -->
                 <div>
                    <h3 class="font-bold text-indigo-400 mb-2">BOFU</h3>
                    <label class="block text-sm font-medium text-gray-300">Avg. CTR (%)</label>
                    <input type="number" step="0.01" id="modal_bofu_ctr" class="modal-input mt-1">
                    <label class="block text-sm font-medium text-gray-300 mt-2">Avg. CPC ($)</label>
                    <input type="number" step="0.01" id="modal_bofu_cpc" class="modal-input mt-1">
                </div>
                <hr class="border-gray-600">
                <!-- Retention Inputs -->
                 <div>
                    <h3 class="font-bold text-indigo-400 mb-2">Funnel Retention Calculator</h3>
                    <div class="mt-2 space-y-2">
                        <p class="text-sm text-gray-400">TOFU → MOFU</p>
                        <label class="block text-xs font-medium text-gray-300">Past TOFU Reach</label>
                        <input type="number" id="modal_past_tofu_reach" class="modal-input">
                        <label class="block text-xs font-medium text-gray-300">Resulting MOFU Reach</label>
                        <input type="number" id="modal_past_mofu_reach" class="modal-input">
                        <p class="text-sm text-gray-300 mt-1">Calculated Retention: <span id="calc_mofu_retention" class="calculated-percent">0%</span></p>
                    </div>
                     <div class="mt-4 space-y-2">
                        <p class="text-sm text-gray-400">MOFU → BOFU</p>
                        <label class="block text-xs font-medium text-gray-300">Past MOFU Reach</label>
                        <input type="number" id="modal_past_mofu_reach_2" class="modal-input">
                        <label class="block text-xs font-medium text-gray-300">Resulting BOFU Reach</label>
                        <input type="number" id="modal_past_bofu_reach" class="modal-input">
                        <p class="text-sm text-gray-300 mt-1">Calculated Retention: <span id="calc_bofu_retention" class="calculated-percent">0%</span></p>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex flex-col sm:flex-row justify-between items-center gap-3">
                <button id="resetKpiChanges" class="modal-button bg-gray-600 hover:bg-gray-700 w-full sm:w-auto">Reset</button>
                <div class="flex gap-3 w-full sm:w-auto">
                    <button id="applyForSession" class="modal-button bg-green-600 hover:bg-green-700 w-full">Apply</button>
                    <button id="saveAsNewPreset" class="modal-button bg-yellow-500 hover:bg-yellow-600 w-full">Save New</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        let presets = {
            "Default": {
                tofu: { cost_per_1000_reach: 10.50, ctr: 0.0225 },
                mofu: { ctr: 0.0452, cpc: 0.54 },
                bofu: { ctr: 0.0608, cpc: 0.85 },
                retention: { mofu_from_tofu: 0.75, bofu_from_mofu: 0.60 }
            },
            "Industry Standard": {
                tofu: { cost_per_1000_reach: 9.50, ctr: 0.0180 },
                mofu: { ctr: 0.0350, cpc: 0.95 },
                bofu: { ctr: 0.0500, cpc: 1.25 },
                retention: { mofu_from_tofu: 0.65, bofu_from_mofu: 0.50 }
            }
        };
        let activePresetName = "Default";
        let metrics = presets[activePresetName];

        // --- DOM ELEMENTS ---
        const tofuSpendInput = document.getElementById('tofuSpend');
        const frequencyGoalInput = document.getElementById('frequencyGoal');
        const frequencyValueEl = document.getElementById('frequencyValue');
        const exportButton = document.getElementById('exportButton');
        const editKpisButton = document.getElementById('editKpisButton');
        const kpiModal = document.getElementById('kpiModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const resetKpiChanges = document.getElementById('resetKpiChanges');
        const applyForSession = document.getElementById('applyForSession');
        const saveAsNewPreset = document.getElementById('saveAsNewPreset');
        const presetSelector = document.getElementById('presetSelector');
        const modalTitle = document.getElementById('modalTitle');
        
        const modalPastTofuReach = document.getElementById('modal_past_tofu_reach');
        const modalPastMofuReach = document.getElementById('modal_past_mofu_reach');
        const modalPastMofuReach2 = document.getElementById('modal_past_mofu_reach_2');
        const modalPastBofuReach = document.getElementById('modal_past_bofu_reach');
        const calcMofuRetentionEl = document.getElementById('calc_mofu_retention');
        const calcBofuRetentionEl = document.getElementById('calc_bofu_retention');

        let currentPredictions = {};
        let tempMofuRetention = 0;
        let tempBofuRetention = 0;
        let calculationTimeout;

        // --- PRESET & DATA FUNCTIONS ---
        function loadPresets() {
            const savedPresets = localStorage.getItem('campaignPredictorPresets');
            if (savedPresets) {
                try {
                    const parsed = JSON.parse(savedPresets);
                    // Basic validation to ensure it's an object
                    if (typeof parsed === 'object' && parsed !== null) {
                        presets = parsed;
                    }
                } catch (e) {
                    console.error("Could not parse presets from localStorage", e);
                }
            }
            const savedActive = localStorage.getItem('campaignPredictorActivePreset');
            if (savedActive && presets[savedActive]) {
                activePresetName = savedActive;
            } else {
                activePresetName = "Default"; // Fallback to default
            }
            metrics = { ...presets[activePresetName] }; // Use a copy for session edits
        }

        function savePresets() {
            localStorage.setItem('campaignPredictorPresets', JSON.stringify(presets));
            localStorage.setItem('campaignPredictorActivePreset', activePresetName);
        }
        
        function populatePresetDropdown() {
            presetSelector.innerHTML = '';
            for (const name in presets) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                presetSelector.appendChild(option);
            }
            presetSelector.value = activePresetName;
        }
        
        function switchPreset(name) {
            if (presets[name]) {
                activePresetName = name;
                metrics = { ...presets[activePresetName] }; // Load a fresh copy
                savePresets();
                updateKpiDisplay();
                onInputChange(); // Use debounced calculation
            }
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateKpiDisplay() {
            const currentMetrics = presets[activePresetName];
            if (!currentMetrics) return; // Guard clause
            
            document.getElementById('tofu-cpm-metric').textContent = `$${currentMetrics.tofu.cost_per_1000_reach.toFixed(2)}`;
            document.getElementById('tofu-ctr-metric').textContent = `${(currentMetrics.tofu.ctr * 100).toFixed(2)}%`;
            document.getElementById('mofu-ctr-metric').textContent = `${(currentMetrics.mofu.ctr * 100).toFixed(2)}%`;
            document.getElementById('mofu-cpc-metric').textContent = `$${currentMetrics.mofu.cpc.toFixed(2)}`;
            document.getElementById('bofu-ctr-metric').textContent = `${(currentMetrics.bofu.ctr * 100).toFixed(2)}%`;
            document.getElementById('bofu-cpc-metric').textContent = `$${currentMetrics.bofu.cpc.toFixed(2)}`;
            document.getElementById('mofu-retention-metric').textContent = `${(currentMetrics.retention.mofu_from_tofu * 100).toFixed(0)}%`;
            document.getElementById('bofu-retention-metric').textContent = `${(currentMetrics.retention.bofu_from_mofu * 100).toFixed(0)}%`;
        }

        function animateValue(element, start, end, duration, formatFn) {
            // FIX: Add a guard clause to prevent error if the element doesn't exist
            if (!element) {
                console.error("animateValue called on a null element. Check your element IDs.");
                return;
            }
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const easedProgress = progress * (2 - progress); // Ease-out
                const currentValue = start + (end - start) * easedProgress;
                element.textContent = formatFn(currentValue);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }
        
        function calculatePredictions() {
            const oldPredictions = { ...currentPredictions };
            const tofuSpend = parseFloat(tofuSpendInput.value) || 0;
            const frequencyGoal = parseFloat(frequencyGoalInput.value) || 1;

            const tofuReach = (metrics.tofu.cost_per_1000_reach > 0 ? (tofuSpend / metrics.tofu.cost_per_1000_reach) * 1000 : 0);
            const tofuClicks = tofuReach * metrics.tofu.ctr;
            const mofuPool = tofuReach;
            const mofuReach = mofuPool * metrics.retention.mofu_from_tofu;
            const mofuClicks = mofuReach * metrics.mofu.ctr;
            const mofuSpend = mofuClicks * metrics.mofu.cpc;
            const bofuPool = mofuReach;
            const bofuReach = bofuPool * metrics.retention.bofu_from_mofu;
            const bofuClicks = bofuReach * metrics.bofu.ctr;
            const bofuSpend = bofuClicks * metrics.bofu.cpc;
            
            const recommendedMofuBudget = mofuSpend * frequencyGoal;
            const recommendedBofuBudget = bofuSpend * frequencyGoal;

            currentPredictions = {
                tofuSpend, tofuReach, tofuClicks, tofuCtr: metrics.tofu.ctr,
                mofuPool, mofuReach, mofuClicks, mofuCtr: metrics.mofu.ctr, mofuSpend,
                bofuPool, bofuReach, bofuClicks, bofuCtr: metrics.bofu.ctr, bofuSpend,
                recommendedMofuBudget, recommendedBofuBudget, frequencyGoal
            };
            
            const format = (num) => num.toLocaleString('en-US', { maximumFractionDigits: 0 });
            const formatCurrency = (num) => num.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            const formatPercent = (num) => `${(num * 100).toFixed(2)}%`;
            
            animateValue(document.getElementById('tofu-reach'), oldPredictions.tofuReach || 0, tofuReach, 500, format);
            animateValue(document.getElementById('tofu-clicks'), oldPredictions.tofuClicks || 0, tofuClicks, 500, format);
            
            // FIX: Add checks to prevent errors if elements are not found
            const tofuCtrEl = document.getElementById('tofu-ctr');
            if (tofuCtrEl) tofuCtrEl.textContent = formatPercent(metrics.tofu.ctr);
            
            animateValue(document.getElementById('mofu-pool'), oldPredictions.mofuPool || 0, mofuPool, 500, format);
            animateValue(document.getElementById('mofu-reach'), oldPredictions.mofuReach || 0, mofuReach, 500, format);
            animateValue(document.getElementById('mofu-clicks'), oldPredictions.mofuClicks || 0, mofuClicks, 500, format);
            
            const mofuCtrEl = document.getElementById('mofu-ctr');
            if (mofuCtrEl) mofuCtrEl.textContent = formatPercent(metrics.mofu.ctr);
            animateValue(document.getElementById('mofu-spend'), oldPredictions.mofuSpend || 0, mofuSpend, 500, formatCurrency);
            
            animateValue(document.getElementById('bofu-pool'), oldPredictions.bofuPool || 0, bofuPool, 500, format);
            animateValue(document.getElementById('bofu-reach'), oldPredictions.bofuReach || 0, bofuReach, 500, format);
            animateValue(document.getElementById('bofu-clicks'), oldPredictions.bofuClicks || 0, bofuClicks, 500, format);
            
            const bofuCtrEl = document.getElementById('bofu-ctr');
            if (bofuCtrEl) bofuCtrEl.textContent = formatPercent(metrics.bofu.ctr);
            animateValue(document.getElementById('bofu-spend'), oldPredictions.bofuSpend || 0, bofuSpend, 500, formatCurrency);

            animateValue(document.getElementById('recommendedMofuBudget'), oldPredictions.recommendedMofuBudget || 0, recommendedMofuBudget, 500, formatCurrency);
            animateValue(document.getElementById('recommendedBofuBudget'), oldPredictions.recommendedBofuBudget || 0, recommendedBofuBudget, 500, formatCurrency);
        }
        
        // --- MODAL FUNCTIONS ---
        function fillModalInputs(kpiData) {
            document.getElementById('modal_tofu_cpm').value = kpiData.tofu.cost_per_1000_reach;
            document.getElementById('modal_tofu_ctr').value = kpiData.tofu.ctr * 100;
            document.getElementById('modal_mofu_ctr').value = kpiData.mofu.ctr * 100;
            document.getElementById('modal_mofu_cpc').value = kpiData.mofu.cpc;
            document.getElementById('modal_bofu_ctr').value = kpiData.bofu.ctr * 100;
            document.getElementById('modal_bofu_cpc').value = kpiData.bofu.cpc;
            modalPastTofuReach.value = '';
            modalPastMofuReach.value = '';
            modalPastMofuReach2.value = '';
            modalPastBofuReach.value = '';
            calcMofuRetentionEl.textContent = `${(kpiData.retention.mofu_from_tofu * 100).toFixed(0)}%`;
            calcBofuRetentionEl.textContent = `${(kpiData.retention.bofu_from_mofu * 100).toFixed(0)}%`;
            tempMofuRetention = kpiData.retention.mofu_from_tofu;
            tempBofuRetention = kpiData.retention.bofu_from_mofu;
        }
        
        function openKpiModal() {
            modalTitle.textContent = `Edit Session KPIs (based on "${activePresetName}")`;
            fillModalInputs(metrics);
            kpiModal.classList.remove('hidden');
        }

        function closeKpiModal() {
            kpiModal.classList.add('hidden');
        }

        function getMetricsFromModal() {
            return {
                tofu: {
                    cost_per_1000_reach: parseFloat(document.getElementById('modal_tofu_cpm').value) || 0,
                    ctr: parseFloat(document.getElementById('modal_tofu_ctr').value) / 100 || 0
                },
                mofu: {
                    ctr: parseFloat(document.getElementById('modal_mofu_ctr').value) / 100 || 0,
                    cpc: parseFloat(document.getElementById('modal_mofu_cpc').value) || 0
                },
                bofu: {
                    ctr: parseFloat(document.getElementById('modal_bofu_ctr').value) / 100 || 0,
                    cpc: parseFloat(document.getElementById('modal_bofu_cpc').value) || 0
                },
                retention: {
                    mofu_from_tofu: tempMofuRetention,
                    bofu_from_mofu: tempBofuRetention
                }
            };
        }

        function handleApplyForSession() {
            metrics = getMetricsFromModal();
            // Don't save to presets, just update calculations for this session
            onInputChange();
            closeKpiModal();
        }

        function handleSaveNewPreset() {
            const newName = prompt("Enter a name for this new preset:", "My Custom Preset");
            if (newName && !presets[newName]) {
                presets[newName] = getMetricsFromModal();
                activePresetName = newName;
                savePresets();
                populatePresetDropdown();
                switchPreset(newName);
                closeKpiModal();
            } else if (presets[newName]) {
                alert("A preset with this name already exists.");
            }
        }

        function calculateMofuRetention() {
            const tofuR = parseFloat(modalPastTofuReach.value) || 0;
            const mofuR = parseFloat(modalPastMofuReach.value) || 0;
            if (tofuR > 0 && mofuR > 0) {
                tempMofuRetention = mofuR / tofuR;
                calcMofuRetentionEl.textContent = `${(tempMofuRetention * 100).toFixed(0)}%`;
            }
        }
        
        function calculateBofuRetention() {
             const mofuR = parseFloat(modalPastMofuReach2.value) || 0;
             const bofuR = parseFloat(modalPastBofuReach.value) || 0;
             if (mofuR > 0 && bofuR > 0) {
                tempBofuRetention = bofuR / mofuR;
                calcBofuRetentionEl.textContent = `${(tempBofuRetention * 100).toFixed(0)}%`;
            }
        }
        
        function exportToCsv() {
            if (!currentPredictions || Object.keys(currentPredictions).length === 0) {
                alert("No data to export. Please adjust inputs first.");
                return;
            }

            const headers = [ "Funnel Stage", "Metric", "Value" ];
            const data = [
                ["TOFU", "Ad Spend", currentPredictions.tofuSpend],
                ["TOFU", "Accounts Reached", currentPredictions.tofuReach],
                ["TOFU", "Predicted Clicks", currentPredictions.tofuClicks],
                ["TOFU", "Predicted CTR", `${(currentPredictions.tofuCtr * 100).toFixed(2)}%`],
                ["MOFU", "Retargeting Pool", currentPredictions.mofuPool],
                ["MOFU", "Accounts Reached", currentPredictions.mofuReach],
                ["MOFU", "Predicted Clicks", currentPredictions.mofuClicks],
                ["MOFU", "Predicted Spend (Baseline)", currentPredictions.mofuSpend],
                ['MOFU', `Recommended Budget (Freq: ${currentPredictions.frequencyGoal})`, currentPredictions.recommendedMofuBudget],
                ["BOFU", "Retargeting Pool", currentPredictions.bofuPool],
                ["BOFU", "Accounts Reached", currentPredictions.bofuReach],
                ["BOFU", "Predicted Clicks", currentPredictions.bofuClicks],
                ["BOFU", "Predicted Spend (Baseline)", currentPredictions.bofuSpend],
                ['BOFU', `Recommended Budget (Freq: ${currentPredictions.frequencyGoal})`, currentPredictions.recommendedBofuBudget],
            ];

            let csvContent = "data:text/csv;charset=utf-8," 
                + headers.join(",") + "\n" 
                + data.map(row => row.map(String).join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "oracle_campaign_predictions.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- EVENT LISTENERS ---
        
        function onInputChange() {
            if(frequencyValueEl) {
                frequencyValueEl.textContent = frequencyGoalInput.value;
            }
            clearTimeout(calculationTimeout);
            calculationTimeout = setTimeout(calculatePredictions, 250);
        }

        tofuSpendInput.addEventListener('input', onInputChange);
        frequencyGoalInput.addEventListener('input', onInputChange);
        
        exportButton.addEventListener('click', exportToCsv);
        editKpisButton.addEventListener('click', openKpiModal);
        resetKpiChanges.addEventListener('click', () => fillModalInputs(presets[activePresetName]));
        applyForSession.addEventListener('click', handleApplyForSession);
        saveAsNewPreset.addEventListener('click', handleSaveNewPreset);
        presetSelector.addEventListener('change', (e) => switchPreset(e.target.value));
        modalPastTofuReach.addEventListener('input', calculateMofuRetention);
        modalPastMofuReach.addEventListener('input', calculateMofuRetention);
        modalPastMofuReach2.addEventListener('input', calculateBofuRetention);
        modalPastBofuReach.addEventListener('input', calculateBofuRetention);
        closeModalButton.addEventListener('click', closeKpiModal);

        // --- INITIALIZATION ---
        window.onload = () => {
            loadPresets();
            populatePresetDropdown();
            updateKpiDisplay();
            onInputChange(); // Use debounced calculation on load
        };
    </script>
</body>
</html>
